<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="portal_my_home_maintenance" inherit_id="portal.portal_my_home" name="My Maintenance" customize_show="True" priority="30">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-set="portal_service_category_enable" t-value="True"/>
        </xpath>
        <xpath expr="//div[@id='portal_service_category']" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/property_tent_portal/static/src/img/maintenance_icon.png'"/>
                <t t-set="title">Maintenance</t>
                <t t-set="text">Track your maintenance requests</t>
                <t t-set="url" t-value="'/my/maintenance'"/>
                <t t-set="placeholder_count" t-value="'maintenance_count'"/>
                <t t-set="count" t-value="maintenance_count"/>
                <t t-set="config_card" t-value="True"/>
            </t>
        </xpath>
    </template>

    <template id="portal_my_maintenance" name="My Maintenance Requests">
        <t t-call="portal.portal_layout">
            <t t-set="page_name" t-value="'maintenance'"/>
            <div class="o_portal_wrap">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1">Maintenance Requests</h2>
                        <div class="text-muted">Submit and track issues for your unit</div>
                    </div>
                    <a class="btn btn-primary" href="/my/maintenance/new">New Request</a>
                </div>
                <t t-if="not requests">
                    <div class="alert alert-warning mt-3">No maintenance requests found.</div>
                </t>
                <t t-if="requests">
                    <div class="table-responsive mt-3">
                        <table class="table table-hover o_portal_table align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Request</th>
                                <th>Date</th>
                                <th>Unit</th>
                                <th>Issue</th>
                                <th>Status</th>
                            </tr>
                            </thead>
                            <tbody>
                            <t t-foreach="requests" t-as="req">
                                <tr>
                                    <td>
                                        <a t-att-href="'/my/maintenance/%s' % req.id">
                                            <t t-esc="req.name"/>
                                        </a>
                                    </td>
                                    <td><t t-esc="req.request_date"/></td>
                                    <td><t t-esc="req.unit_id.name"/></td>
                                    <td><t t-esc="req.issue_type"/></td>
                                    <td><span class="badge text-bg-info text-uppercase"><t t-esc="req.state"/></span></td>
                                </tr>
                            </t>
                            </tbody>
                        </table>
                    </div>
                </t>
                <t t-call="portal.pager"/>
            </div>
        </t>
    </template>

    <template id="portal_maintenance_new" name="New Maintenance Request">
        <t t-call="portal.portal_layout">
            <t t-set="page_name" t-value="'maintenance'"/>
            <div class="o_portal_wrap">
                <h2 class="mb-3">New Maintenance Request</h2>
                <t t-if="request.params.get('error')">
                    <div class="alert alert-danger">Please select a unit and add a description.</div>
                </t>
                <form class="card p-3" action="/my/maintenance/create" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <div class="mb-3">
                        <label class="form-label">Unit</label>
                        <select name="unit_id" class="form-select" required="required">
                            <option value="">Select a unit</option>
                            <t t-foreach="units" t-as="unit">
                                <option t-att-value="unit.id"><t t-esc="unit.name"/></option>
                            </t>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Issue Type</label>
                        <select name="issue_type" class="form-select">
                            <option value="plumbing">Plumbing</option>
                            <option value="electrical">Electrical</option>
                            <option value="hvac">HVAC</option>
                            <option value="appliance">Appliance</option>
                            <option value="structural">Structural</option>
                            <option value="other" selected="selected">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="5" required="required"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Photo (optional)</label>
                        <input type="file" name="photo" class="form-control"/>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                    <a href="/my/maintenance" class="btn btn-link">Cancel</a>
                </form>
            </div>
        </t>
    </template>

    <template id="portal_maintenance_detail" name="Maintenance Request Details">
        <t t-call="portal.portal_layout">
            <t t-set="page_name" t-value="'maintenance'"/>
            <div class="o_portal_wrap">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2 class="mb-1">Maintenance Request <t t-esc="request_rec.name"/></h2>
                        <div class="text-muted">Details and status updates</div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <strong>Request Details</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <div class="text-muted small">Date</div>
                                <div class="fw-semibold"><t t-esc="request_rec.request_date"/></div>
                            </div>
                            <div class="col-sm-6">
                                <div class="text-muted small">Unit</div>
                                <div class="fw-semibold"><t t-esc="request_rec.unit_id.name"/></div>
                            </div>
                            <div class="col-sm-6">
                                <div class="text-muted small">Property</div>
                                <div class="fw-semibold"><t t-esc="request_rec.property_id.name"/></div>
                            </div>
                            <div class="col-sm-6">
                                <div class="text-muted small">Issue Type</div>
                                <div class="fw-semibold"><t t-esc="request_rec.issue_type"/></div>
                            </div>
                            <div class="col-sm-6">
                                <div class="text-muted small">Status</div>
                                <span class="badge text-bg-info text-uppercase"><t t-esc="request_rec.state"/></span>
                            </div>
                            <div class="col-sm-6">
                                <div class="text-muted small">Assigned To</div>
                                <div class="fw-semibold"><t t-esc="request_rec.assigned_to_id.name"/></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <strong>Description</strong>
                    </div>
                    <div class="card-body">
                        <p class="mb-0" style="white-space: pre-wrap;"><t t-esc="request_rec.description"/></p>
                    </div>
                </div>
                <t t-if="request_rec.photo">
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <strong>Photo</strong>
                        </div>
                        <div class="card-body">
                            <img t-att-src="'/web/image/property.maintenance.request/%s/photo' % request_rec.id" class="img-fluid rounded border"/>
                        </div>
                    </div>
                </t>
            </div>
        </t>
    </template>
</odoo>
